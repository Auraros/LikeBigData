# Yarn4 RPC框架详解



## RPC框架背景

> 网络通信模块是分布式系统中最底层的模块，支撑了上层分布式环境下复杂的进程间通信（Inter-Process Communication， IPC）逻辑，是所有分布式系统的基础。远程过程调用(Remote Produce Call, RPC)是一种常用的分布式网络通信协议。



## RPC通信模型介绍

![image-20200924211559208](C:\Users\Auraros\AppData\Roaming\Typora\typora-user-images\image-20200924211559208.png)

- 通信模块

  ```
  两个相互协作的通信模块实现请求-应答协议。负责传递请求和应答，通常为异步方式
  ```

- Stub程序

  ```
  代理程序，客户端和服务段均存在。
  在客户端，负责将信息通过网络模块发送给服务器端
  在服务器端，依次进行解码请求消息中的参数，调用相应的服务过程和编码结果的返回值等处理
  ```

- 调度程序

  ```
  接受来自通信模块的请求信息，并根据其中的标识选择一个stub程序进行处理
  ```

- 客户程序/服务过程

  ```
  请求的发出者和请求的处理者。
  ```



### RPC请求从发出到获取处理结果

1. 客户程序以本地方式调用系统产生的Stub程序
2. 改Stub程序将函数调用信息按照网络通信模块的要求封装成信息包，并交给通信模块发送到远程服务端
3. 远程服务端接受此消息后，将此消息发送给对应的Stub程序
4. Stub程序拆封消息，形成被调过程要求的形式，并调用对应函数
5. 被调用函数按照所获参数执行，并将结果返回给Stub程序
6. Stub程序将此结果封装成消息，通过网络通信模型逐级传给客户程序



## Hadoop RPC 特点

- **透明性：**两台计算机程序互相调用时，感觉像是执行一个本地调用
- **高性能**：各个系统均采用了Master/Slave结构，RPC Server是一个高性能服务器，能够高效地处理来自多个Client地并发RPC请求。
- **可控性：**JDK中有一个RPC框架——RMI，使用Hadoop RPC可以更好地进行参数优化。



### Hadoop RPC 总体架构

![image-20200924213224358](C:\Users\Auraros\AppData\Roaming\Typora\typora-user-images\image-20200924213224358.png)

- 序列化层

  ```
  序列化主要作用是将结构化对象转为字节流以便于通过网络进行传输或写入持久存储。Protocol buffer和Apache Avro均可用在序列化层，Hadoop还有一个本身地Writeable序列化框架
  ```

- 函数调用层

  ```
  定位要调用地函数并执行该函数。Hadoop RPC采用了Java反射机制与动态代理实现了函数调用
  ```

- 网络传输层

  ```
  描述了Client与Server之间消息传输地方式，Hadoop RPC采用了基于 TCP/IP的Socket机制
  ```

- 服务器端处理框架

  ```
  可被抽象为网络I/O模型，描述客户端与服务端间信息交互方式，常见有网络I/O模型有阻塞式I/O，非阻塞式I/O，事件驱动I/O
  ```



